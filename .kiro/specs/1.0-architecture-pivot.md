# Spec: 1.0 Architecture Pivot

## Overview
Migrate Protocol: Silent Night from web-first (Vite + Three.js) to mobile-native (React Native + Expo + BabylonJS React Native).

## Requirements

### R1: Monorepo Structure
- MUST set up pnpm workspace
- MUST have `apps/mobile/` for Expo app
- MUST have `packages/game-core/` for shared DDLs
- SHOULD preserve `apps/web/` for legacy support

### R2: Expo Integration
- MUST use Expo SDK 54+
- MUST configure EAS Build for iOS and Android
- MUST use Expo Router for navigation
- SHOULD support development builds

### R3: BabylonJS React Native
- MUST integrate @babylonjs/react-native
- MUST set up Reactylon for declarative JSX
- MUST achieve 60fps on flagship devices
- SHOULD achieve 30fps on mid-tier devices

### R4: DDL Migration
- MUST preserve all JSON DDL files
- MUST create TypeScript loaders in game-core
- MUST NOT change DDL schema
- SHOULD add runtime validation with Zod

## Design

### Directory Structure
```
protocol-silent-night/
├── apps/
│   ├── mobile/              # Expo app
│   │   ├── app/            # Expo Router pages
│   │   ├── src/            # App-specific code
│   │   ├── app.json        # Expo config
│   │   └── eas.json        # EAS config
│   └── web/                # Legacy (read-only)
├── packages/
│   └── game-core/          # Shared
│       ├── data/           # DDL JSON files
│       ├── systems/        # Game logic
│       └── types/          # TypeScript types
└── pnpm-workspace.yaml
```

### Migration Sequence
1. Set up monorepo skeleton
2. Move DDLs to packages/game-core
3. Create Expo app shell
4. Integrate BabylonJS React Native
5. Port one scene (isometric camera)
6. Verify 60fps on device
7. Continue with remaining features

## Tasks

### Tier 1: Foundation
- [ ] T1.1: Create pnpm-workspace.yaml
- [ ] T1.2: Create apps/mobile/ with Expo init
- [ ] T1.3: Create packages/game-core/ with DDLs
- [ ] T1.4: Configure EAS Build profiles

### Tier 2: BabylonJS Integration
- [ ] T2.1: Install @babylonjs/react-native
- [ ] T2.2: Install reactylon
- [ ] T2.3: Create basic scene component
- [ ] T2.4: Add isometric camera
- [ ] T2.5: Profile FPS on real device

### Tier 3: DDL Loading
- [ ] T3.1: Create TypeScript DDL loaders
- [ ] T3.2: Add Zod schemas for validation
- [ ] T3.3: Create Zustand store for game state
- [ ] T3.4: Wire DDLs to scene components

## Acceptance Criteria
- [ ] `pnpm dev:mobile` starts Expo dev server
- [ ] App runs on iOS Simulator
- [ ] App runs on Android Emulator
- [ ] Empty BabylonJS scene renders at 60fps
- [ ] DDL files load correctly
- [ ] No Three.js imports in mobile app
