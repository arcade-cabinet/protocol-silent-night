name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read

jobs:
  detect-stack:
    name: Detect Stack
    runs-on: ubuntu-latest
    outputs:
      has_rust: ${{ steps.detect.outputs.has_rust }}
      has_node: ${{ steps.detect.outputs.has_node }}
      has_python: ${{ steps.detect.outputs.has_python }}
      has_go: ${{ steps.detect.outputs.has_go }}
      has_docs: ${{ steps.detect.outputs.has_docs }}
    steps:
      - uses: actions/checkout@v4
      - name: Detect project type
        id: detect
        run: |
          echo "has_rust=$([[ -f Cargo.toml ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_node=$([[ -f package.json ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_python=$([[ -f pyproject.toml || -f setup.py || -f requirements.txt ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_go=$([[ -f go.mod ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_docs=$([[ -d docs ]] && echo true || echo false)" >> $GITHUB_OUTPUT

  rust:
    name: Rust
    needs: detect-stack
    if: needs.detect-stack.outputs.has_rust == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
      - uses: swatinem/rust-cache@v2
      - run: cargo build --release
      - run: cargo test
      - run: cargo clippy -- -D warnings
      - run: cargo fmt -- --check

  node:
    name: Node.js
    needs: detect-stack
    if: needs.detect-stack.outputs.has_node == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: pnpm
      - run: pnpm install --no-frozen-lockfile
      - run: pnpm run lint
      - run: pnpm run build
      - run: pnpm run test:unit

  python:
    name: Python
    needs: detect-stack
    if: needs.detect-stack.outputs.has_python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install
        run: |
          pip install ruff pytest
          if [[ -f requirements.txt ]]; then pip install -r requirements.txt; fi
          if [[ -f pyproject.toml ]]; then pip install -e ".[dev]" 2>/dev/null || pip install -e . 2>/dev/null || true; fi
      - run: ruff check .
      - run: pytest

  go:
    name: Go
    needs: detect-stack
    if: needs.detect-stack.outputs.has_go == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - run: go build -v ./...
      - run: go test -v ./...

  docs-build:
    name: Build & Sync Docs
    needs: detect-stack
    if: needs.detect-stack.outputs.has_docs == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docs (Generic)
        run: |
          if [ -f docs/Makefile ]; then
            cd docs && make html
          elif [ -f package.json ] && grep -q "build:docs" package.json; then
            pnpm run build:docs
          elif [ -f Cargo.toml ]; then
            cargo doc --no-deps
          fi

      - name: Sync to Org Docs Repo
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          ORG: arcade-cabinet
          REPO: ${{ github.event.repository.name }}
        run: |
          # Create temporary clone of docs repo
          git clone https://x-access-token:${GH_TOKEN}@github.com/${ORG}/.github.git /tmp/docs-repo
          mkdir -p /tmp/docs-repo/docs/api/${REPO}

          # Copy built docs (heuristics for common locations)
          if [ -d docs/_build/html ]; then
            cp -r docs/_build/html/* /tmp/docs-repo/docs/api/${REPO}/
          elif [ -d docs/dist ]; then
            cp -r docs/dist/* /tmp/docs-repo/docs/api/${REPO}/
          elif [ -d target/doc ]; then
            cp -r target/doc/* /tmp/docs-repo/docs/api/${REPO}/
          fi

          cd /tmp/docs-repo
          git add .
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "docs: update API docs for ${REPO}" || exit 0
          git push origin main
