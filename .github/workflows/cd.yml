# CD Workflow - Build, Test, Deploy (All Branches)
#
# ARCHITECTURE:
# - Unified workflow handling ALL branch types
# - Conditional deployment based on branch/event
# - DRY: Single source of truth for build steps
#
# BRANCH STRATEGY:
# - main: Production deployment + docs sync
# - release/*: Staging preview deployment
# - feature/* and other branches: Build + test only
# - pull_request: CI validation (no deployment)
# - release event: Package publishing
#
# Managed by: [ORG]/control-center

name: CD

on:
  push:
    branches:
      - main
      - 'release/**'
      - 'feature/**'
      - 'feat/**'
      - 'fix/**'
      - 'chore/**'
  pull_request:
    branches: [main, 'release/**']
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deployment target (auto, staging, production, none)'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - staging
          - production
          - none

permissions:
  contents: write
  id-token: write
  packages: write
  pull-requests: write

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  ORG_NAME: ${{ github.repository_owner }}
  REPO_NAME: ${{ github.event.repository.name }}

jobs:
  # ==========================================================================
  # Detect & Setup (All Branches)
  # ==========================================================================
  detect:
    name: Detect Stack & Branch
    runs-on: ubuntu-latest
    # Skip for portal and control-center repos
    if: |
      !endsWith(github.repository, '.github.io') &&
      !endsWith(github.repository, 'control-center')
    outputs:
      # Stack detection
      is_python: ${{ steps.detect.outputs.is_python }}
      is_node: ${{ steps.detect.outputs.is_node }}
      is_rust: ${{ steps.detect.outputs.is_rust }}
      is_go: ${{ steps.detect.outputs.is_go }}
      is_expo: ${{ steps.detect.outputs.is_expo }}
      # Event/branch detection
      is_release: ${{ steps.detect.outputs.is_release }}
      is_main: ${{ steps.detect.outputs.is_main }}
      is_release_branch: ${{ steps.detect.outputs.is_release_branch }}
      is_pr: ${{ steps.detect.outputs.is_pr }}
      # Deployment decisions
      should_deploy: ${{ steps.detect.outputs.should_deploy }}
      deploy_target: ${{ steps.detect.outputs.deploy_target }}
      should_publish: ${{ steps.detect.outputs.should_publish }}
      should_sync_docs: ${{ steps.detect.outputs.should_sync_docs }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          sparse-checkout: |
            pyproject.toml
            package.json
            Cargo.toml
            go.mod
            app.json
            apps/mobile/app.json
          sparse-checkout-cone-mode: false

      - id: detect
        run: |
          # Stack detection
          echo "is_python=$([[ -f pyproject.toml ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "is_node=$([[ -f package.json ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "is_rust=$([[ -f Cargo.toml ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "is_go=$([[ -f go.mod ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "is_expo=$([[ -f app.json || -f apps/mobile/app.json ]] && echo true || echo false)" >> $GITHUB_OUTPUT

          # Event detection
          echo "is_release=$([[ '${{ github.event_name }}' == 'release' ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "is_pr=$([[ '${{ github.event_name }}' == 'pull_request' ]] && echo true || echo false)" >> $GITHUB_OUTPUT

          # Branch detection
          BRANCH="${{ github.ref_name }}"
          IS_MAIN=$([[ "$BRANCH" == "main" || "$BRANCH" == "master" ]] && echo true || echo false)
          IS_RELEASE_BRANCH=$([[ "$BRANCH" == release/* ]] && echo true || echo false)
          echo "is_main=$IS_MAIN" >> $GITHUB_OUTPUT
          echo "is_release_branch=$IS_RELEASE_BRANCH" >> $GITHUB_OUTPUT

          # Deployment decisions (DRY logic)
          DEPLOY_INPUT="${{ inputs.deploy_target }}"
          EVENT="${{ github.event_name }}"

          # Determine deployment target
          if [[ "$DEPLOY_INPUT" == "none" ]]; then
            DEPLOY_TARGET="none"
            SHOULD_DEPLOY=false
          elif [[ "$DEPLOY_INPUT" == "production" || "$EVENT" == "release" ]]; then
            DEPLOY_TARGET="production"
            SHOULD_DEPLOY=true
          elif [[ "$DEPLOY_INPUT" == "staging" || "$IS_RELEASE_BRANCH" == "true" ]]; then
            DEPLOY_TARGET="staging"
            SHOULD_DEPLOY=true
          elif [[ "$IS_MAIN" == "true" && "$EVENT" != "pull_request" ]]; then
            DEPLOY_TARGET="production"
            SHOULD_DEPLOY=true
          else
            DEPLOY_TARGET="none"
            SHOULD_DEPLOY=false
          fi

          echo "deploy_target=$DEPLOY_TARGET" >> $GITHUB_OUTPUT
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT

          # Publish only on release events
          echo "should_publish=$([[ '${{ github.event_name }}' == 'release' ]] && echo true || echo false)" >> $GITHUB_OUTPUT

          # Sync docs only on main or production deploy
          echo "should_sync_docs=$([[ "$IS_MAIN" == "true" && "$EVENT" != "pull_request" ]] && echo true || echo false)" >> $GITHUB_OUTPUT

          # Summary
          echo "ðŸ“‹ Branch: $BRANCH"
          echo "ðŸ“¦ Event: $EVENT"
          echo "ðŸŽ¯ Deploy target: $DEPLOY_TARGET"
          echo "ðŸš€ Should deploy: $SHOULD_DEPLOY"

  # ==========================================================================
  # Python: Build, Test, Release, Docs
  # ==========================================================================
  python:
    name: Python CD
    needs: detect
    if: needs.detect.outputs.is_python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run tests
        run: uv run pytest || echo "No tests found"

      # Release to PyPI (only on release event)
      - name: Build & Publish
        if: needs.detect.outputs.should_publish == 'true'
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}
        run: |
          uv build
          uv publish --token "$UV_PUBLISH_TOKEN" || echo "Already published or no token"

      # Build Sphinx documentation (only if deploying)
      - name: Build Documentation
        if: needs.detect.outputs.should_sync_docs == 'true'
        run: |
          mkdir -p docs-output

          # Try Sphinx with autodoc2
          if [ -f docs/conf.py ]; then
            uv run sphinx-build -b html docs docs/_build/html
            uv pip install sphinx-markdown-builder 2>/dev/null || true
            uv run sphinx-build -b markdown docs docs/_build/md 2>/dev/null || true

            if [ -d docs/_build/md ]; then
              cp -r docs/_build/md/* docs-output/
            else
              cp -r docs/_build/html/* docs-output/
            fi
          else
            uv pip install pdoc 2>/dev/null || true
            uv run pdoc --output-dir docs-output --format md $(find src -name "*.py" -type f | head -1 | xargs dirname) 2>/dev/null || \
            echo "# API Documentation\n\nSee source code for details." > docs-output/index.md
          fi

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        if: needs.detect.outputs.should_sync_docs == 'true'
        with:
          name: docs-python
          path: docs-output/

  # ==========================================================================
  # Node.js/TypeScript: Build, Test, Release, Docs
  # ==========================================================================
  nodejs:
    name: Node.js CD
    needs: detect
    if: needs.detect.outputs.is_node == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Install & Build
        run: |
          pnpm install --frozen-lockfile || pnpm install
          pnpm build || true

      - name: Run tests
        run: pnpm test || echo "No tests found"

      - name: Type check
        run: pnpm typecheck || pnpm tsc --noEmit || true

      # Release to npm (only on release event)
      - name: Publish to npm
        if: needs.detect.outputs.should_publish == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: pnpm publish --access public --no-git-checks || echo "Already published or no token"

      # Build TypeDoc documentation (only if deploying)
      - name: Build Documentation
        if: needs.detect.outputs.should_sync_docs == 'true'
        run: |
          mkdir -p docs-output

          pnpm add -D typedoc typedoc-plugin-markdown 2>/dev/null || true

          if pnpm run docs 2>/dev/null; then
            cp -r docs/* docs-output/ 2>/dev/null || true
          else
            npx typedoc --plugin typedoc-plugin-markdown --out docs-output src/ 2>/dev/null || \
            echo "# API Documentation\n\nSee source code for details." > docs-output/index.md
          fi

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        if: needs.detect.outputs.should_sync_docs == 'true'
        with:
          name: docs-nodejs
          path: docs-output/

  # ==========================================================================
  # Expo Mobile: Build Preview or Production
  # ==========================================================================
  expo:
    name: Expo Mobile
    needs: detect
    if: needs.detect.outputs.is_expo == 'true' && needs.detect.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '22'
          cache: 'pnpm'

      - uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile || pnpm install

      - name: Build Preview (Staging)
        if: needs.detect.outputs.deploy_target == 'staging'
        working-directory: apps/mobile
        run: |
          echo "ðŸ”§ Building staging preview..."
          eas build --platform all --profile preview --non-interactive || echo "EAS not configured"

      - name: Build Production
        if: needs.detect.outputs.deploy_target == 'production'
        working-directory: apps/mobile
        run: |
          echo "ðŸš€ Building production..."
          eas build --platform all --profile production --non-interactive || echo "EAS not configured"

      - name: Submit to Stores
        if: needs.detect.outputs.should_publish == 'true'
        working-directory: apps/mobile
        run: |
          echo "ðŸ“¤ Submitting to app stores..."
          eas submit --platform all --non-interactive || echo "EAS submit not configured"

  # ==========================================================================
  # Rust: Build, Test, Release, Docs
  # ==========================================================================
  rust:
    name: Rust CD
    needs: detect
    if: needs.detect.outputs.is_rust == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7
        with:
          toolchain: stable

      - uses: swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.7.8

      - name: Build
        run: cargo build --release

      - name: Test
        run: cargo test

      # Release to crates.io (only on release event)
      - name: Publish to crates.io
        if: needs.detect.outputs.should_publish == 'true'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish || echo "Already published or no token"

      # Build rustdoc (only if deploying)
      - name: Build Documentation
        if: needs.detect.outputs.should_sync_docs == 'true'
        run: |
          cargo doc --no-deps
          mkdir -p docs-output
          cp -r target/doc/* docs-output/

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        if: needs.detect.outputs.should_sync_docs == 'true'
        with:
          name: docs-rust
          path: docs-output/

  # ==========================================================================
  # Go: Build, Test, Release, Docs
  # ==========================================================================
  golang:
    name: Go CD
    needs: detect
    if: needs.detect.outputs.is_go == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version: '1.22'

      - name: Build
        run: go build -v ./...

      - name: Test
        run: go test -v ./...

      # Build Go documentation (only if deploying)
      - name: Build Documentation
        if: needs.detect.outputs.should_sync_docs == 'true'
        run: |
          mkdir -p docs-output

          echo "# API Documentation" > docs-output/index.md
          echo "" >> docs-output/index.md
          go doc -all ./... >> docs-output/index.md 2>/dev/null || true

          go install golang.org/x/pkgsite/cmd/pkgsite@latest 2>/dev/null || true

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v4
        if: needs.detect.outputs.should_sync_docs == 'true'
        with:
          name: docs-go
          path: docs-output/

  # ==========================================================================
  # Sync Documentation to Org Portal (Main Branch Only)
  # ==========================================================================
  sync-docs:
    name: Sync to Portal
    needs: [detect, python, nodejs, rust, golang]
    if: |
      always() &&
      !cancelled() &&
      needs.detect.outputs.should_sync_docs == 'true' &&
      (needs.python.result == 'success' || needs.nodejs.result == 'success' ||
       needs.rust.result == 'success' || needs.golang.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Download all docs artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v4
        with:
          path: all-docs
          pattern: docs-*
          merge-multiple: true

      - name: Sync to org documentation portal
        env:
          DOCS_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          ORG: ${{ env.ORG_NAME }}
          REPO: ${{ env.REPO_NAME }}
        run: |
          PORTAL="${ORG}.github.io"

          # Derive package ID (strip common prefixes)
          PACKAGE_ID=$(echo "$REPO" | sed 's/^strata-//' | sed 's/^agentic-//' | sed 's/^extended-//')

          echo "ðŸ“š Syncing docs for $REPO â†’ $PORTAL/src/content/docs/$PACKAGE_ID/"

          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          # Clone portal
          if ! git clone "https://x-access-token:${DOCS_TOKEN}@github.com/${ORG}/${PORTAL}.git" portal 2>/dev/null; then
            echo "âš ï¸ Portal repo ${ORG}/${PORTAL} not found - skipping sync"
            exit 0
          fi

          # Target directory
          TARGET="portal/src/content/docs/packages/${PACKAGE_ID}"
          mkdir -p "$TARGET"

          # Copy docs
          if [ -d "all-docs" ] && [ "$(ls -A all-docs 2>/dev/null)" ]; then
            cp -r all-docs/* "$TARGET/"

            # Ensure frontmatter for Starlight
            for f in "$TARGET"/*.md; do
              if [ -f "$f" ] && ! grep -q "^---" "$f"; then
                TITLE=$(basename "$f" .md | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')
                sed -i "1i---\ntitle: $TITLE\n---\n" "$f"
              fi
            done

            # Create index if missing
            if [ ! -f "$TARGET/index.md" ] && [ ! -f "$TARGET/index.mdx" ]; then
              echo "---" > "$TARGET/index.mdx"
              echo "title: $REPO" >> "$TARGET/index.mdx"
              echo "description: API documentation for $REPO" >> "$TARGET/index.mdx"
              echo "---" >> "$TARGET/index.mdx"
              echo "" >> "$TARGET/index.mdx"
              echo "# $REPO" >> "$TARGET/index.mdx"
              echo "" >> "$TARGET/index.mdx"
              echo "Auto-generated API documentation." >> "$TARGET/index.mdx"
              echo "" >> "$TARGET/index.mdx"
              echo "See the [source repository](https://github.com/${ORG}/${REPO}) for more details." >> "$TARGET/index.mdx"
            fi
          fi

          cd portal
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "docs($PACKAGE_ID): sync from $REPO

            Auto-synced from: https://github.com/${ORG}/${REPO}
            Triggered by: ${{ github.event_name }}"

            git push origin main
            echo "âœ… Documentation synced successfully"
          else
            echo "â„¹ï¸ No documentation changes"
          fi

  # ==========================================================================
  # Summary Job (Always Runs)
  # ==========================================================================
  summary:
    name: CD Summary
    needs: [detect, python, nodejs, expo, rust, golang, sync-docs]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "## CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Event | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Target | \`${{ needs.detect.outputs.deploy_target }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Should Deploy | \`${{ needs.detect.outputs.should_deploy }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Should Publish | \`${{ needs.detect.outputs.should_publish }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs Sync | \`${{ needs.detect.outputs.should_sync_docs }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| detect | ${{ needs.detect.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| python | ${{ needs.python.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| nodejs | ${{ needs.nodejs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| expo | ${{ needs.expo.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| rust | ${{ needs.rust.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| golang | ${{ needs.golang.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| sync-docs | ${{ needs.sync-docs.result }} |" >> $GITHUB_STEP_SUMMARY
