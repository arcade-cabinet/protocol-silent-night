# Claude Code Workflows for Protocol: Silent Night
#
# Comprehensive AI-powered automation including:
# - Interactive @claude mentions
# - Automatic PR code review
# - Issue triage and labeling
# - Weekly maintenance
# - Security reviews
#
# Security: Only trusted users can trigger interactive mode

name: Claude Code

on:
  # Interactive: @claude mentions
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  issues:
    types: [opened, assigned, labeled]

  # Automatic: PR review
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

  # Scheduled: Weekly maintenance
  schedule:
    - cron: "0 0 * * 0" # Every Sunday at midnight UTC

  # Manual trigger for maintenance
  workflow_dispatch:
    inputs:
      task:
        description: "Task to run"
        required: true
        type: choice
        options:
          - maintenance
          - security-audit
          - dependency-update
        default: "maintenance"

jobs:
  # ============================================
  # INTERACTIVE MODE: @claude mentions
  # ============================================
  claude-interactive:
    name: Claude Interactive
    if: |
      (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
        (github.event_name == 'issues' && github.event.action == 'opened' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
      ) && (
        (
          (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
          (
            github.event.comment.author_association == 'OWNER' ||
            github.event.comment.author_association == 'MEMBER' ||
            github.event.comment.author_association == 'COLLABORATOR' ||
            github.event.sender.login == github.repository_owner
          )
        ) ||
        (
          github.event_name == 'pull_request_review' &&
          (
            github.event.review.author_association == 'OWNER' ||
            github.event.review.author_association == 'MEMBER' ||
            github.event.review.author_association == 'COLLABORATOR' ||
            github.event.sender.login == github.repository_owner
          )
        ) ||
        (
          github.event_name == 'issues' &&
          (
            github.event.sender.login == github.repository_owner ||
            github.event.issue.user.login == github.repository_owner
          )
        )
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          additional_permissions: |
            actions: read

          claude_args: |
            --allowedTools "Edit,MultiEdit,Write,Read,Glob,Grep,LS,Bash(pnpm:*),Bash(npx:*),Bash(node:*),Bash(git:*),Bash(gh:*),Bash(cat:*),Bash(ls:*),Bash(head:*),Bash(tail:*),Bash(grep:*),Bash(rg:*),Bash(find:*),Bash(mkdir:*),Bash(rm:*),Bash(cp:*),Bash(mv:*),Bash(touch:*),Bash(echo:*),Bash(curl:*),Bash(which:*),Bash(pwd:*),Bash(wc:*),Bash(sort:*),Bash(diff:*),Bash(jq:*),Bash(tsc:*),Bash(vitest:*),Bash(playwright:*),Bash(vite:*),WebFetch,NotebookEditCell"

  # ============================================
  # AUTO PR REVIEW: With progress tracking
  # ============================================
  claude-review:
    name: Claude PR Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude PR Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          allowed_bots: "*"
          additional_permissions: |
            actions: read

          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ## Project: Protocol: Silent Night

            Christmas-themed vampire survivors game with:
            - Vanilla TypeScript + Vite
            - Canvas 2D rendering
            - Entity-Component architecture
            - Vitest for testing
            - Playwright for E2E

            ## Review Checklist

            ### Code Quality
            - [ ] TypeScript types properly defined
            - [ ] No console.log in production code
            - [ ] Functions have clear purposes
            - [ ] Code follows existing patterns

            ### Performance (Critical for game)
            - [ ] Game loop optimized
            - [ ] Object pooling for entities
            - [ ] No memory leaks
            - [ ] Canvas operations efficient

            ### Testing
            - [ ] Unit tests for new logic
            - [ ] E2E tests for UI changes

            ### Game Balance
            - [ ] New features balanced
            - [ ] Nice Points economy intact
            - [ ] Difficulty scaling appropriate

            Use inline comments for specific issues.
            Post summary with checklist results.

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Read,Glob,Grep,LS,Bash(gh:*),Bash(git diff:*),Bash(git log:*),Bash(git show:*),Bash(cat:*),Bash(ls:*),Bash(rg:*),Bash(tsc:*)"

  # ============================================
  # ISSUE TRIAGE: Auto-label new issues
  # ============================================
  claude-triage:
    name: Claude Issue Triage
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Triage Issue
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_non_write_users: "*"
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}
            TITLE: ${{ github.event.issue.title }}
            BODY: ${{ github.event.issue.body }}
            AUTHOR: ${{ github.event.issue.user.login }}

            ## Project: Protocol: Silent Night
            A Christmas-themed vampire survivors game.

            ## Triage Instructions

            Analyze this issue and determine:
            1. **Type**: bug, feature, enhancement, question, documentation
            2. **Area**: gameplay, ui, audio, enemies, weapons, performance, testing
            3. **Priority**: critical, high, medium, low

            ## Label Mapping
            - Bug reports → "bug"
            - Feature requests → "enhancement"
            - Questions → "question"
            - Gameplay → "gameplay"
            - UI/HUD → "ui"
            - Audio → "audio"
            - Enemies/spawning → "enemies"
            - Weapons/upgrades → "weapons"
            - Performance → "performance"

            Add appropriate labels using:
            `gh issue edit ${{ github.event.issue.number }} --add-label "label1,label2"`

          claude_args: |
            --allowedTools "Read,Bash(gh issue:*),Bash(gh search:*)"

  # ============================================
  # WEEKLY MAINTENANCE
  # ============================================
  claude-maintenance:
    name: Claude Weekly Maintenance
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.task == 'maintenance')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Maintenance Check
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            REPO: ${{ github.repository }}

            ## Weekly Maintenance Tasks

            1. **Dependency Audit**
               - Run `pnpm audit` to check for vulnerabilities
               - Check for outdated packages with `pnpm outdated`

            2. **Code Health**
               - Run `pnpm run typecheck` for type errors
               - Check for TODO/FIXME comments: `rg "TODO|FIXME" src/`

            3. **Test Health**
               - Run `pnpm test` and report results
               - Check test coverage

            4. **Issue Hygiene**
               - List issues older than 30 days
               - Identify stale issues

            Create a single issue titled "Weekly Maintenance Report - [DATE]" summarizing findings.

          claude_args: |
            --allowedTools "Read,Glob,Grep,LS,Bash(pnpm:*),Bash(gh:*),Bash(git:*),Bash(rg:*),Bash(cat:*),Bash(ls:*)"

  # ============================================
  # SECURITY AUDIT: Manual trigger
  # ============================================
  claude-security:
    name: Claude Security Audit
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.task == 'security-audit'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Security Audit
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            REPO: ${{ github.repository }}

            ## Security Audit

            1. **Dependencies**: Run `pnpm audit`
            2. **Secrets**: Search for hardcoded keys/tokens
            3. **localStorage**: Check data validation
            4. **Build**: Check for exposed source maps

            Create a security report as GitHub issue.
            Rate findings: CRITICAL, HIGH, MEDIUM, LOW

          claude_args: |
            --allowedTools "Read,Glob,Grep,LS,Bash(pnpm:*),Bash(gh:*),Bash(rg:*),Bash(cat:*),Bash(ls:*)"

  # ============================================
  # DEPENDENCY UPDATE: Manual trigger
  # ============================================
  claude-deps:
    name: Claude Dependency Update
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.task == 'dependency-update'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Update Dependencies
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}

          prompt: |
            REPO: ${{ github.repository }}

            ## Dependency Update

            1. Check `pnpm outdated`
            2. Update patch/minor versions safely
            3. Run `pnpm install`, `pnpm run typecheck`, `pnpm test`
            4. Create PR with changes

          claude_args: |
            --allowedTools "Edit,Write,Read,Glob,LS,Bash(pnpm:*),Bash(git:*),Bash(gh:*),Bash(cat:*),Bash(ls:*)"
